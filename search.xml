<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[自己搭个小监控]]></title>
    <url>%2F2019%2F02%2F02%2F%E8%87%AA%E5%B7%B1%E6%90%AD%E4%B8%AA%E5%B0%8F%E7%9B%91%E6%8E%A7%2F</url>
    <content type="text"><![CDATA[自己搭个小监控起因搭了个VPS，隔了段时间发现ssh错误日志有点多。 就想怎么看一下都是谁天天搞事情。 /var/log/auth.log -rw-r----- 1 root adm 185827 2月 2 11:09 /var/log/auth.log /var/log/btmp -rw-rw---- 1 root utmp 271488 2月 2 11:09 /var/log/btmp 架构VPS买的是最便宜的单CPU，空间就20GB。所以没有能力搞个大架构T_T，搭个ES基本就做不了别的了。只能自己利用系统功能小搞。 1、 auth.log日志最全，但是正则匹配太复杂，也耗时间。平衡再三，最后用lastb机制把错误登陆日志搞出，在用sed和正则匹配想要的字段生成文件。2、 利用logrotate每次滚动执行命令，拿出日志。3、 利用python脚本，pandas库，产生md文件和图片，生成静态blog文档。4、 用hexo做博客，corntab每天自动执行hexo上传blog到github。 lastb语法: lastb [-adRx][-f &lt;记录文件&gt;][-n &lt;显示列数&gt;][帐号名称…][终端机编号…] 参数说明： -a 把从何处登入系统的主机名称或IP地址显示在最后一行。 -d 将IP地址转换成主机名称。 -f&lt;记录文件&gt; 指定记录文件。 -n&lt;显示列数&gt;或-&lt;显示列数&gt; 设置列出名单的显示列数。 -R 不显示登入系统的主机名称或IP地址。 -x 显示系统关机，重新开机，以及执行等级的改变等信息。 sedlastb -F -f /var/log/btmpdays/btmp.1 | sed -r &apos;s/(.+)\s+ssh:notty\s+(\S+)\s+(.*)-.*/\1---&gt;\2---&gt;\3/g&apos;|sed &apos;$d&apos;|sed &apos;/^$/d&apos; &gt; /tmp/btmp.log 制作分隔符分隔符真的比较讨厌，本来直接用空格做分隔，发现用户名竟然能带空格,最后就用了 &apos;---&gt;&apos; 加多次分隔的方式把日志格式化了。 去掉无用信息btmp日志会多出两行，一个空行和一个btmp信息行，需要去掉。 sed ‘$d’|sed ‘/^$/d’ 日志位置这个日志是中间文件，其实没啥用处，就放到/tmp里面吧。 logrotate/var/log/btmp { missingok daily create 0660 root utmp rotate 7 olddir /var/log/btmpdays/ sharedscripts postrotate lastb -F -f /var/log/btmpdays/btmp.1 | sed -r &apos;s/(.+)\s+ssh:notty\s+(\S+)\s+(.*)-.*/\1---&gt;\2---&gt;\3/g&apos;|sed &apos;$d&apos;|sed &apos;/^$/d&apos; &gt; /tmp/btmp.log python /var/log/btmpdays/totext.py endscript } ### 执行脚本 利用postrotate机制执行命令，需要说的是写上sharedscripts让脚本只执行一次。 python、pandaspandas在linux命令行产生图片有个大坑。需要修改配置文件：Linux中，创建文件 ~/.config/matplotlib/matplotlibrc， （其中，~/.config/matplotlib/是配置文件matplotlibrc的路径）修改一下 backend : Agg。 corntab用户hexo每天执行hexo上传命令 mysql 文件导入一开始想用脚本搞定文件入库，发现日期字段有坑，于是绕过。利用pandas的to_sql，上传数据入库。 dfdb.to_sql(‘btmplog’,engine,if_exists=’append’, index= False)]]></content>
  </entry>
  <entry>
    <title><![CDATA[reportlog-2019-02-02]]></title>
    <url>%2F2019%2F02%2F02%2Freportlog-2019-02-02%2F</url>
    <content type="text"><![CDATA[reportlog-2019-02-02lines TOP USERSroot 1027suporte 12postgres 10admin 10upload 10student 10administ 8deploy 8usuario 8sa 8oracle 8io 6isaque 6nginx 6kz 6lever 6user02 6albertha 6anton 6clodoald 6Name: user, dtype: int64 TOP IPS112.85.42.87 829115.230.127.27 196185.188.218.6 20135.ip-192-99-24 12178.128.115.183 12150.161.8.163 10188.131.181.224 10203.159.249.215 10186.120.93.42 10ec2-52-44-102-36 10190.233.160.141 10crypto.beeone.co 10118.24.126.31 10207.154.232.160 10163.172.169.222 1064.ip-51-254-201 10140.143.93.31 1080.211.236.160 10151.ip-164-132-2 10154.222.138.208 10Name: from, dtype: int64]]></content>
      <categories>
        <category>whocoming</category>
      </categories>
      <tags>
        <tag>ssh</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[index.html]]></title>
    <url>%2F2019%2F01%2F25%2Findex-html%2F</url>
    <content type="text"></content>
  </entry>
  <entry>
    <title><![CDATA[test]]></title>
    <url>%2F2019%2F01%2F24%2Ftest%2F</url>
    <content type="text"><![CDATA[hello world again #1 test1 dsafd #2 fdasfasdf sadfdsafsadfsadfasdfasdfsadfasdfasdfasdfas ffdsfasdfsadfsadf ‘’’just a test‘’’]]></content>
      <categories>
        <category>搭建博客</category>
      </categories>
      <tags>
        <tag>test1</tag>
        <tag>test2</tag>
        <tag>test3</tag>
      </tags>
  </entry>
</search>
